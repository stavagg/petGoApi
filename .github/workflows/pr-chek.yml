name: ðŸ” Pull Request Check

on:
  pull_request:
    branches: [ main ]

jobs:
  pr-validation:
    name: ðŸ“‹ PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ¹ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    
    - name: ðŸ§ª Run tests
      run: go test ./... -v
    
    - name: ðŸŽ¯ Check code formatting
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ Code is not properly formatted. Please run:"
          echo "gofmt -s -w ."
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… Code is properly formatted"
    
    - name: ðŸ” Vet code
      run: go vet ./...
    
    - name: ðŸ“Š Coverage check
      run: |
        go test ./... -coverprofile=coverage.out
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
        echo "**Coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
        
        if (( $(echo "$COVERAGE < 20" | bc -l) )); then
          echo "âŒ Coverage dropped below 20%"
          exit 1
        fi

    - name: ðŸ’¬ Comment PR
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸ¤– **Automated PR Check**\n\nâœ… All checks passed!\nâœ… Tests are passing\nâœ… Code is properly formatted\nâœ… Coverage meets requirements\n\nReady for review! ðŸš€'
          })
